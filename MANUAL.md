# Vidana App — Platform Manual

> **Stack:** Next.js 15 · TypeScript · Tailwind CSS · shadcn/ui · Firebase (Auth + Firestore) · App Hosting
> **Timezone:** All dates are stored as UTC ISO-8601 strings and displayed in **America/Mexico_City**.
> **Auto-deploy:** Pushes to `main` on GitHub trigger a build in Firebase App Hosting. Publishing must be triggered manually from Firebase Studio.

---

## Table of Contents

1. [User Roles](#1-user-roles)
2. [Authentication](#2-authentication)
3. [Selection — Dashboard Hub](#3-selection--dashboard-hub)
4. [Registros — Meal Registration](#4-registros--meal-registration-main)
5. [Comanda — Kitchen Display](#5-comanda--kitchen-display-command)
6. [POS Inditex](#6-pos-inditex)
7. [Kiosk Televisa](#7-kiosk-televisa)
8. [Reportes — Analytics](#8-reportes--analytics)
9. [Inventario — Inventory](#9-inventario--inventory)
10. [Recetas — Recipes & Weekly Menu](#10-recetas--recipes--weekly-menu)
11. [Costos — Cost Tracking](#11-costos--cost-tracking)
12. [Facturación — Billing](#12-facturación--billing)
13. [Configuración — Admin Settings](#13-configuración--admin-settings)
14. [Admin Dashboard](#14-admin-dashboard)
15. [Data Model](#15-data-model)
16. [Known Limitations](#16-known-limitations)

---

## 1. User Roles

| Role | Access |
|------|--------|
| **admin** | All pages and all companies' data |
| **user** | Registros and Comanda for their assigned company only |

A user's role and `companyId` are stored in `/users/{uid}` in Firestore. Admins can invite new users via **Configuración → Usuarios**.

---

## 2. Authentication

### Login (`/login`)
- **Email + password** or **Google OAuth** (popup with redirect fallback for Safari).
- Friendly error messages in Spanish for common Firebase errors (wrong password, user not found, etc.).
- Forgot password: opens an inline dialog to send a reset email.

### Sign Up (`/signup`)
- Requires a **valid invite link** generated by an admin (7-day expiry, single-use).
- The invite can optionally pre-fill the company assignment.
- Domain whitelist can be enforced via `appConfig/default` in Firestore.
- Invite links look like: `https://app.url/signup?invite=<inviteId>`

### Reset Password (`/reset-password`)
- Handles the Firebase email link for password resets.
- Validates the reset code, shows a form with new password + confirmation.
- Redirects to `/login` on success.

---

## 3. Selection — Dashboard Hub

**Route:** `/selection`
**Access:** All authenticated users

This is the home screen after login. It shows:

| KPI Card | Description |
|----------|-------------|
| **Comidas hoy** | Non-voided consumptions today (Mexico City timezone) |
| **Comidas este mes** | Non-voided consumptions since the 1st of the current month |
| **Empresas activas** | Total companies (admin) or 1 (non-admin with company assigned) |

Below the KPIs is a **quick-access grid** with buttons to all platform sections.

> **Non-admin users with no company assigned** see a message to contact the administrator.

---

## 4. Registros — Meal Registration (`/main`)

**Route:** `/main`
**Access:** All authenticated users

The core daily-use page for cafeteria staff. Has three tabs:

### Tab: Registros (default)
- **Company selector** (admin sees all; non-admin is locked to their company).
- **Employee search**: type a name or employee number → matching employees appear as chips.
- Click an employee chip → immediately creates a consumption record in Firestore.
- **CSV import**: upload a `.csv` file with columns `employeeNumber,name` to bulk-register meals.

### Tab: Historial
- **Date range picker**: filter consumptions by date.
- Table shows: employee name, number, timestamp, status (paid/pending), voided flag.
- **Row actions**: Void a single consumption | mark paid/pending.
- **Batch actions**: select multiple rows → void batch | mark batch as paid.
- **Export**: download the filtered results as a CSV file.
- **Print**: opens a printable report view.

### Tab: Estadísticas
- Bar chart of daily meal counts for the current month.
- Summary stats: total meals this month, daily average, busiest day.
- Compares current month vs. previous month.

---

## 5. Comanda — Kitchen Display (`/command`)

**Route:** `/command`
**Access:** All authenticated users (admin gets a company selector)

Real-time kitchen order board. Refreshes instantly via Firestore `onSnapshot`.

### Pending Orders (top section)
- Shows all non-voided, **status = pending** consumptions from today.
- Each card displays: employee name, employee number, ordered items with quantities, elapsed time (refreshes every 30 s).
- **"Completar" button**: marks the order as `status = completed`.
- Badge at the top shows the live count of pending orders.

### Completados Hoy (collapsible section)
- Shows today's completed orders (most recent 20).
- Collapsible — click header to toggle.

> **Important:** The Comanda only shows consumptions that have the `items` array (kiosk/POS orders). Simple meal registrations from the Registros tab appear as "Consumo sin detalle de ítem".

---

## 6. POS Inditex

**Route:** `/pos-inditex`
**Access:** Admin only

A point-of-sale terminal for **anonymous / walk-in sales** at the Inditex cafeteria.

- Shows the Inditex company menu organized by category tabs.
- Staff add items to a cart, adjust quantities with +/− buttons.
- Clicking **"Confirmar Orden"** opens a summary dialog.
- Confirming creates a consumption with `employeeId = 'anonymous'` and `employeeNumber = 'POS'`.
- A print-ready 80 mm receipt dialog appears after order confirmation.

> **Note:** These anonymous consumptions ARE included in Admin and Costos revenue totals (they were previously excluded — this was fixed).

---

## 7. Kiosk Televisa

**Route:** `/kiosk`
**Access:** Admin only

A self-service kiosk terminal for the **Televisa** cafeteria.

- On load, fetches the Televisa company's employees, menu items, and last-30-day consumptions.
- **Employee search**: type name or number → select from matching results.
- Menu organized by category tabs, with +/− quantity controls.
- **"Confirmar Pedido"** opens a receipt preview dialog with print option.
- Includes a **"Reporte"** tab showing consumption history for the last 30 days with a date range filter.

---

## 8. Reportes — Analytics

**Route:** `/reportes`
**Access:** Admin only

Three analytics tabs powered by Recharts:

### Tab: Tendencias (6-month meal & revenue trend)
- Bar chart: monthly meal counts.
- Line chart: monthly revenue (using each company's `mealPrice` × meals).
- Summary table below the chart.

### Tab: Costos (multi-line cost chart)
- Lines: food cost, labor cost, waste cost, food cost % target.
- Pulls data from `purchaseOrders`, `laborCosts`, `stockMovements` across all companies.

### Tab: Menú (top dishes)
- Horizontal bar chart of the 10 most-ordered dishes for the selected month.
- Month selector (current + 5 previous months).
- Counts item frequency from the `items` array in consumptions.

---

## 9. Inventario — Inventory

**Route:** `/inventario`
**Access:** Admin only

Full inventory management across three tabs:

### Tab: Ingredientes
- List of all ingredients with: name, category, unit, current stock, minimum stock, cost/unit, supplier.
- **Add / Edit**: form dialog with all fields.
- Inline stock level indicator (green / yellow / red based on min stock).

### Tab: Proveedores (Suppliers)
- CRUD list of suppliers with: name, contact, phone, email, active status.

### Tab: Movimientos (Stock Movements)
- Log any stock change: `entrada` (receipt), `salida` (usage), `ajuste` (correction), `merma` (waste).
- Each movement records: ingredient, type, quantity, unit cost, reason, timestamp.
- History table filterable by company.

### Tab: Órdenes de Compra (Purchase Orders)
- Create a PO: select supplier, add line items (ingredient + quantity + unit cost).
- PO statuses: `borrador` (draft) → `enviado` (sent) → `recibido` (received).
- Marking as **recibido** auto-creates `entrada` stock movements for each line item.

> **Company selector** persists to `localStorage` so users don't have to re-select on every visit.

---

## 10. Recetas — Recipes & Weekly Menu

**Route:** `/recetas`
**Access:** Admin only

Three tabs:

### Tab: Recetas
- Assign ingredients + quantities to each menu item.
- Auto-calculates **cost per portion** from ingredient `costPerUnit`.
- Displays **margin %** = `(price − costPerPortion) / price × 100`.
- Edit / delete recipes inline.

### Tab: Menú Semanal (Weekly Menu Planner)
- Grid of Mon–Fri columns.
- Drag/select menu items into each day slot.
- **Planificar con IA** button: calls the `/api/ai/plan-menu` endpoint with the current menu and recipe costs → Gemini suggests a balanced weekly menu respecting the company's `targetFoodCostPct`.

### Tab: Lista de Compras (Shopping List)
- Auto-generated from the current weekly menu's recipes.
- For each ingredient: required quantity (from recipes) vs. current stock → shows shortfall.
- Estimated total cost for items that need to be ordered.

---

## 11. Costos — Cost Tracking

**Route:** `/costos`
**Access:** Admin only

Monthly P&L view showing **Ingresos, Costos, and Margen Neto**.

### KPI Cards (top row)
| Card | Source |
|------|--------|
| **Ingresos** | All non-voided consumptions × `mealPrice` (with daily minimum logic — see below) |
| **Costo Alimentos** | Sum of received `purchaseOrders.totalCost` for the month |
| **Costo Laboral** | Sum of `laborCosts.amount` for the month |
| **Merma** | Sum of `stockMovements` where `type = 'merma'` × `unitCost` |
| **% Costo Alim.** | `foodCost / revenue × 100` |
| **Margen Neto** | `revenue − totalCost` |

### Revenue Calculation (Daily Minimum Logic)
If a company has `dailyTarget > 0`:
- **Monday–Thursday**: `MAX(actual_daily_count, dailyTarget) × mealPrice`
- **Friday–Sunday**: `actual_count × mealPrice`

This matches the Admin Dashboard calculation exactly.

### Distribución de Costos (Pie Chart)
Breakdown of Alimentos / Labor / Merma as percentages.

### Costo por Comida
- Total cost ÷ meals served.
- Target is < $80 MXN/meal.

### Por Cocina (Per-Kitchen Cards)
Each company gets a card showing: meals, revenue, food cost, labor, waste, and margin.

### Filter
Company dropdown at the top filters all KPIs and charts to a single company or "Todas las cocinas".

### Add Labor Cost
The **"+ Costo Laboral"** button opens a dialog to register a manual labor cost entry (amount + notes) for a specific company.

---

## 12. Facturación — Billing

**Route:** `/facturacion`
**Access:** Admin only

Monthly invoice management.

### Month Selector
Up to 6 months of history. Defaults to current month.

### KPI Summary
- Total meals billed
- Total amount billed
- Count of invoices in each status (pendiente / enviado / pagado)

### Per-Company Invoice Cards
Each company gets a card showing:
- Meal count and calculated total (with daily minimum logic)
- **Status dropdown**: pendiente → enviado → pagado (persists to `company.billingStatus[yyyy-MM]` in Firestore)
- **Download PDF**: generates a formatted invoice PDF via `jsPDF`
- **Download Excel**: generates an Excel workbook via `xlsx`
- **Enviar por Email**: calls a Firebase Function (`sendInvoiceEmail`) with the PDF as base64 — sends to `company.billingEmail`

---

## 13. Configuración — Admin Settings

**Route:** `/configuracion`
**Access:** Admin only

Four management tabs:

### Tab: Empresas
- CRUD list of companies.
- Fields: name, access code, meal price, daily target, target food cost %, billing email, billing note.

### Tab: Empleados
- Company selector.
- Table of all employees for the selected company.
- **Add / Edit / Deactivate** employee records.
- **CSV Import**: upload a file with `employeeNumber,name,department,email` columns.
- **CSV Export**: download all employees as a spreadsheet.

### Tab: Menú
- Company selector.
- CRUD for menu items: name, category, price, SKU.
- Items are grouped by category in display.

### Tab: Usuarios (Invites)
- **Create invite**: choose role (admin/user) and company → generates a 7-day single-use invite link.
- Copy-to-clipboard button for easy sharing.
- Lists existing pending invites with expiry dates.

---

## 14. Admin Dashboard

**Route:** `/admin`
**Access:** Admin only

High-level monthly summary across all companies.

### KPI Row
- **Total comidas servidas** (all companies)
- **Total ingresos del mes** (all companies combined)

### Per-Company Grid
Each company card shows:
- Meal count for the month
- Revenue for the month (daily minimum logic applied)
- `mealPrice` and `dailyTarget` metadata

Uses `collectionGroup` to query all `consumptions` subcollections in a single Firestore read.

---

## 15. Data Model

### Firestore Collections

```
/users/{uid}
  uid, name, email, role, companyId

/companies/{companyId}
  name, accessCode, mealPrice, dailyTarget, billingEmail,
  billingStatus, targetFoodCostPct, billingNote

/companies/{companyId}/consumptions/{id}
  employeeId, employeeNumber, name, companyId, timestamp (ISO),
  voided, items[], totalAmount, status (pending|completed)

/companies/{companyId}/employees/{id}
  employeeNumber, name, companyId, department, email, active

/companies/{companyId}/menuItems/{id}
  sku, name, price, category, companyId

/companies/{companyId}/stockMovements/{id}
  ingredientId, ingredientName, type, quantity, reason,
  purchaseOrderId, createdBy, timestamp (ISO), unitCost, companyId

/companies/{companyId}/purchaseOrders/{id}
  supplierId, supplierName, items[], status, totalCost,
  createdAt (ISO), receivedAt (ISO), createdBy, companyId

/companies/{companyId}/ingredients/{id}
  name, unit, currentStock, minStock, category, costPerUnit,
  supplierId, active

/companies/{companyId}/suppliers/{id}
  name, contact, phone, email, active

/companies/{companyId}/recipes/{menuItemId}
  menuItemId, menuItemName, servings, ingredients[], costPerPortion, updatedAt

/companies/{companyId}/weeklyMenus/{id}
  weekStartDate, companyId, days{lunes…viernes: menuItemId[]}

/companies/{companyId}/laborCosts/{id}
  companyId, weekStartDate, amount, notes, createdBy

/invites/{id}
  companyId, role, createdBy, createdAt, expiresAt, email, used

/appConfig/default
  allowedDomains[]
```

### Key Conventions
- **`timestamp`** fields are always stored as **ISO-8601 UTC strings** (e.g. `"2025-02-01T14:30:00.000Z"`).
- **`companyId`** is denormalized into subcollection documents to allow `collectionGroup` queries.
- **`voided: true`** soft-deletes a consumption (never hard-deleted).
- **`status`** on consumptions is optional — records without it are assumed `pending` for backward compatibility.

---

## 16. Known Limitations

| Area | Limitation |
|------|-----------|
| **Comanda** | Only shows consumptions with an `items[]` array (kiosk/POS orders). Simple meal taps from Registros show as "Sin detalle de ítem". |
| **Billing PDFs** | Requires `jsPDF` and `xlsx` to be properly installed. Type definitions may need updating in some environments. |
| **Firebase Functions** | Invoice email function (`sendInvoiceEmail`) is deployed in Cloud Functions. TypeScript errors in `functions/src/index.ts` are pre-existing and do not affect production. |
| **Kiosk / POS** | Hardcoded to specific companies (Televisa for Kiosk, Inditex for POS). Changing the target company requires updating the environment variable `NEXT_PUBLIC_KIOSK_COMPANY_ID`. |
| **Offline** | The app requires an active internet connection. Firestore offline persistence is not enabled. |
| **No pagination** | Some pages (Reportes, Inventario) load all data for the month without pagination. Expect slowness for companies with very high transaction volumes. |
| **Invite race condition** | Two users clicking the same invite link at exactly the same time could both succeed. This is an acknowledged, low-risk limitation at current scale. |

---

## Common Workflows

### Register a meal (staff)
1. Go to **Registros** (`/main`).
2. Select the company (admin) or it's pre-selected (non-admin).
3. Type the employee name or number in the search box.
4. Click the matching employee chip → meal is recorded instantly.

### Mark a kitchen order as done (kitchen staff)
1. Go to **Comanda** (`/command`).
2. Find the pending order card.
3. Click **"Completar"** → card moves to the Completados section.

### Create a monthly invoice
1. Go to **Facturación** (`/facturacion`).
2. Select the month.
3. On the company card, click **"Descargar PDF"** or **"Descargar Excel"**.
4. Change status to **enviado** after sending, then **pagado** once payment is received.

### Add a labor cost entry
1. Go to **Costos** (`/costos`).
2. Click **"+ Costo Laboral"** in the top right.
3. Select the company, enter the amount and optional notes.
4. Click **"Registrar"**.

### Plan the weekly menu with AI
1. Go to **Recetas** (`/recetas`) → **Menú Semanal** tab.
2. Select the company.
3. Click **"Planificar con IA"**.
4. Review the suggested menu and adjust as needed.

### Invite a new user
1. Go to **Configuración** (`/configuracion`) → **Usuarios** tab.
2. Click **"Nueva Invitación"**.
3. Select role and company.
4. Copy the generated link and share it with the new user.
5. The link expires in 7 days and is single-use.

---

*Last updated: 2026-02-27*
